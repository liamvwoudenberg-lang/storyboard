
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users can create and manage their own user profile
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      allow create: if request.auth.uid != null;
    }

    match /documents/{documentId} {
      // Helper functions
      function isOwner() {
        return request.auth.uid == resource.data.ownerId;
      }

      function isEditor() {
        return resource.data.roles[request.auth.uid] == 'editor' || isOwner();
      }

      function isViewer() {
        return resource.data.roles[request.auth.uid] == 'viewer' || isEditor();
      }

      function isPublicViewer() {
        return resource.data.publicAccess == 'viewer' || isPublicEditor();
      }

      function isPublicEditor() {
        return resource.data.publicAccess == 'editor';
      }

      // Rules
      // Any authenticated user can create a document.
      allow create: if request.auth.uid != null;

      // Viewers can read, public can read if allowed
      allow read: if (request.auth.uid != null && isViewer()) || isPublicViewer();
      
      // Editors can update, but not if they are a guest
      allow update: if ((request.auth.uid != null && isEditor()) || isPublicEditor());

      // Guests (unauthenticated users) can update a public document,
      // but only to add comments. We enforce this by ensuring other critical fields are not changed.
      allow update: if request.auth == null && isPublicViewer() &&
                      request.resource.data.projectTitle == resource.data.projectTitle &&
                      request.resource.data.aspectRatio == resource.data.aspectRatio &&
                      request.resource.data.ownerId == resource.data.ownerId &&
                      request.resource.data.publicAccess == resource.data.publicAccess &&
                      request.resource.data.roles == resource.data.roles;

      // Only owners can delete
      allow delete: if isOwner();
    }
  }
}
