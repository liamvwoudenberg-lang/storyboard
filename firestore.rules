rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users can create and manage their own user profile
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      allow create: if request.auth.uid != null;
    }

    match /storyboards/{documentId} {
      // Helper functions
      function isGuest() {
        let userPath = /databases/$(database)/documents/users/$(request.auth.uid);
        return exists(userPath) && get(userPath).data.get('isGuest', false) == true;
      }

      function isOwner() {
        // For existing documents (read/update/delete)
        let isExistingOwner = resource != null && request.auth.uid == resource.data.ownerId;
        // For new documents (create)
        let isNewOwner = resource == null && request.auth.uid == request.resource.data.ownerId;
        return isExistingOwner || isNewOwner;
      }

      function isEditor() {
        // Checks if the user has the 'editor' role or is the owner.
        // Note: The roles map is keyed by email. This rule assumes a custom claim or another mechanism
        // to resolve the user's email to their UID, which is not shown here.
        // This rule will likely fail for non-owner editors.
        return (resource != null && resource.data.roles[request.auth.uid] == 'editor') || isOwner();
      }

      function isViewer() {
        // Checks if the user has the 'viewer' role or is an editor (which includes owner).
        // This rule has the same potential issue as isEditor().
        return (resource != null && resource.data.roles[request.auth.uid] == 'viewer') || isEditor();
      }

      function isPublicViewer() {
        return resource != null && (resource.data.publicAccess == 'viewer' || isPublicEditor());
      }

      function isPublicEditor() {
        return resource != null && resource.data.publicAccess == 'editor';
      }

      // Rules

      // Allow authenticated users to list their own documents.
      allow list: if request.auth.uid != null;

      // Allow viewers to get a single document.
      allow get: if (request.auth.uid != null && isViewer()) || isPublicViewer();

      // Allow non-guest authenticated users to create a document they own.
      allow create: if request.auth.uid != null && !isGuest() && isOwner();

      // Allow editors to update.
      allow update: if (request.auth.uid != null && isEditor()) || isPublicEditor();

      // Allow owners to delete.
      allow delete: if isOwner();
    }
  }
}
