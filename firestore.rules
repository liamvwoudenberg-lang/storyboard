rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check role
    function hasRole(doc, userId, role) {
      return userId in doc.data().roles && doc.data().roles[userId] == role;
    }

    // Helper function to check public access
    function hasPublicAccess(doc, accessLevel) {
      return doc.data().publicAccess == accessLevel;
    }

    match /documents/{documentId} {
      // Allow read access based on role or public access
      allow read: if hasRole(get(/databases/$(database)/documents/documents/$(documentId)), request.auth.uid, 'viewer')
                   || hasRole(get(/databases/$(database)/documents/documents/$(documentId)), request.auth.uid, 'editor')
                   || hasRole(get(/databases/$(database)/documents/documents/$(documentId)), request.auth.uid, 'owner')
                   || hasPublicAccess(get(/databases/$(database)/documents/documents/$(documentId)), 'viewer')
                   || hasPublicAccess(get(/databases/$(database)/documents/documents/$(documentId)), 'editor');

      // Allow update access based on role or public access
      allow update: if hasRole(get(/databases/$(database)/documents/documents/$(documentId)), request.auth.uid, 'editor')
                    || hasRole(get(/databases/$(database)/documents/documents/$(documentId)), request.auth.uid, 'owner')
                    || hasPublicAccess(get(/databases/$(database)/documents/documents/$(documentId)), 'editor');

      // Allow delete only for owner
      allow delete: if hasRole(get(/databases/$(database)/documents/documents/$(documentId)), request.auth.uid, 'owner');

      // Only owner can manage permissions
      allow update: if request.auth.uid == resource.data().ownerId
                    && (request.resource.data().diff(resource.data()).affectedKeys().hasAny(['roles', 'publicAccess']));
    }
  }
}