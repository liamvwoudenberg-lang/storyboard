rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users can create and manage their own user profile
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      allow create: if request.auth.uid != null;
    }

    match /storyboards/{documentId} {
      // Helper functions
      function isGuest() {
        let userPath = /databases/$(database)/documents/users/$(request.auth.uid);
        // Check if the user document exists, and if it does, check the 'isGuest' field.
        // A non-existent profile means the user is not a guest.
        return exists(userPath) && get(userPath).data.get('isGuest', false) == true;
      }

      // For create operations, where 'resource' is not available.
      function isCreatingOwnDocument() {
        return request.auth.uid == request.resource.data.ownerId;
      }

      // For existing documents.
      function isOwner() {
        return request.auth.uid == resource.data.ownerId;
      }

      function isEditor() {
        // IMPORTANT: This rule is likely bugged. It checks for a UID in a map of emails.
        return resource.data.roles[request.auth.uid] == 'editor' || isOwner();
      }

      function isViewer() {
        // IMPORTANT: This rule is likely bugged. It checks for a UID in a map of emails.
        return resource.data.roles[request.auth.uid] == 'viewer' || isEditor();
      }

      function isPublicViewer() {
        return resource.data.publicAccess == 'viewer' || isPublicEditor();
      }

      function isPublicEditor() {
        return resource.data.publicAccess == 'editor';
      }

      // Rules

      // Allow authenticated users to list documents. 
      // The client-side code is filtering to only show documents they own.
      allow list: if request.auth.uid != null;

      // Viewers can read a single document, public can read if allowed
      allow get: if (request.auth.uid != null && isViewer()) || isPublicViewer();
      
      // Any non-guest authenticated user can create a document,
      // and they must be the owner of the new document.
      allow create: if request.auth.uid != null && !isGuest() && isCreatingOwnDocument();

      // Editors can update. Guests can update public docs with restrictions.
      allow update: if (request.auth.uid != null && isEditor()) || isPublicEditor() ||
                      (request.auth == null && isPublicViewer() &&
                      request.resource.data.projectTitle == resource.data.projectTitle &&
                      request.resource.data.aspectRatio == resource.data.aspectRatio &&
                      request.resource.data.ownerId == resource.data.ownerId &&
                      request.resource.data.publicAccess == resource.data.publicAccess &&
                      request.resource.data.roles == resource.data.roles);

      // Only owners can delete
      allow delete: if isOwner();
    }
  }
}
